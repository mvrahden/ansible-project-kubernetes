---
- name: Continuation of master setup
  hosts: kube_cluster
  gather_facts: true
  pre_tasks:
    - debug:
        var: "{{ item }}"
      with_items:
        - groups
        - play_hosts

    - name: Output general host and OS details
      debug:
        msg: "{{ item }}"
      with_items:
        - "{{ ansible_hostname }} | {{ inventory_hostname }} | {{ inventory_hostname_short }} | {{ ansible_host }} | {{ hostvars[inventory_hostname]['ansible_' + k8s_advertise_address_int]['ipv4']['address'] }}"
        - "{{ os_family }} | {{ os_distro }} | {{ os_codename }} | {{ target_node_arch }}"

  roles:
    - role: networking-setup
      subtasks: [ 'hostname' ] # , 'netfilter'
      domain: "{{ kube_primary_domain }}"
      network_interfaces: 
        - "{{ kube_wired_interface }}"

- name: Setup further common packages (ntp, apt-cache-ng)
  hosts: kube_cluster
  pre_tasks:
    - name: Wait for devices accessibility
      # just to ensure that devices are up and running after bootstrap-run
      wait_for_connection:
        connect_timeout: 20
        sleep: 5
        delay: 5
        timeout: 180

    - name: Disabling Swap
      # Kubernetes dislikes swap memory
      service:
        name: dphys-swapfile
        enabled: false
        state: stopped
      become: true

  roles:
    - role: mvrahden/ansible-ntp
      ntp_pri_domain_name: "{{ kube_primary_domain }}"
    - role: mvrahden/ansible-apt-cacher-ng
      apt_cacher_server: "{{ k8s_master | default(None) or groups['kube_master'][0] }}"
      enable_apt_caching: true
